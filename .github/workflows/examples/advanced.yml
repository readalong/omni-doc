# Advanced Omni-Doc Workflow
# Copy this to your repo's .github/workflows/omni-doc.yml

name: Documentation Analysis

on:
  pull_request:
    types: [closed]
    # Only run for PRs targeting main/master
    branches:
      - main
      - master
    # Only run if these paths are changed
    paths:
      - 'src/**'
      - 'lib/**'
      - '*.py'
      - '*.ts'
      - '*.js'

jobs:
  omni-doc:
    # Only run if PR was merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      # Skip if certain labels are present
      - name: Check for skip labels
        id: labels
        run: |
          LABELS='${{ toJson(github.event.pull_request.labels.*.name) }}'
          if echo "$LABELS" | grep -qiE '"skip-docs"|"dependencies"|"dependabot"|"chore"'; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Omni-Doc
        if: steps.labels.outputs.skip != 'true'
        uses: readalong/omni-doc@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          google-api-key: ${{ secrets.GOOGLE_API_KEY }}
          enable-diagrams: 'true'

      - name: Summary
        if: steps.labels.outputs.skip != 'true'
        run: |
          echo "## Omni-Doc Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "PR: ${{ github.event.pull_request.html_url }}" >> $GITHUB_STEP_SUMMARY
